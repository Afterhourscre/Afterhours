<?xml version="1.0"?>
<!--
/**
 * Mageplaza
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Mageplaza.com license that is
 * available through the world-wide-web at this URL:
 * https://www.mageplaza.com/LICENSE.txt
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    Mageplaza
 * @package     Mageplaza_Barclaycard
 * @copyright   Copyright (c) Mageplaza (https://www.mageplaza.com/)
 * @license     https://www.mageplaza.com/LICENSE.txt
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <preference for="Mageplaza\Barclaycard\Api\PaymentInterface" type="Mageplaza\Barclaycard\Model\Api\Payment"/>
    <preference for="Mageplaza\Barclaycard\Api\GuestPaymentInterface" type="Mageplaza\Barclaycard\Model\Api\GuestPayment"/>

    <!-- Fix bug magento 2.3.1 when preparing invoice item -->
    <type name="Magento\Sales\Model\Service\InvoiceService">
        <plugin name="mpbarclaycard_invoice_service" type="Mageplaza\Barclaycard\Plugin\Model\InvoiceServicePlugin"/>
    </type>

    <!-- Command managers section -->
    <type name="Magento\Payment\Gateway\Command\CommandManagerPool">
        <arguments>
            <argument name="executors" xsi:type="array">
                <item name="mpbarclaycard_direct" xsi:type="string">MpBarclaycardDirectCommandManager</item>
                <item name="mpbarclaycard_hosted" xsi:type="string">MpBarclaycardHostedCommandManager</item>
            </argument>
        </arguments>
    </type>

    <!-- ========================================== DIRECT INTEGRATION ========================================== -->

    <!-- Payment Method Facade configuration -->
    <virtualType name="MpBarclaycardDirectFacade" type="Mageplaza\Barclaycard\Model\Payment\Direct">
        <arguments>
            <argument name="code" xsi:type="const">Mageplaza\Barclaycard\Model\Payment\Direct::CODE</argument>
            <argument name="formBlockType" xsi:type="string">Mageplaza\Barclaycard\Block\Form\Cc</argument>
            <argument name="infoBlockType" xsi:type="string">MpBarclaycardDirectInfoBlock</argument>
            <argument name="valueHandlerPool" xsi:type="object">MpBarclaycardDirectValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">MpBarclaycardDirectValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">MpBarclaycardDirectCommandPool</argument>
        </arguments>
    </virtualType>

    <!-- Configuration reader -->
    <type name="Mageplaza\Barclaycard\Gateway\Config\Direct">
        <arguments>
            <argument name="methodCode" xsi:type="const">Mageplaza\Barclaycard\Model\Payment\Direct::CODE</argument>
        </arguments>
    </type>
    <virtualType name="MpBarclaycardDirectCountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Direct</argument>
        </arguments>
    </virtualType>
    <virtualType name="MpBarclaycardDirectValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">MpBarclaycardDirectCountryValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Logger, initialized with Direct Config -->
    <virtualType name="MpBarclaycardDirectLog" type="Magento\Payment\Model\Method\Logger">
        <arguments>
            <argument name="config" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Direct</argument>
        </arguments>
    </virtualType>

    <!-- Commands infrastructure -->
    <virtualType name="MpBarclaycardDirectCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">MpBarclaycardDirectAuthorizeCommand</item>
                <item name="capture" xsi:type="string">MpBarclaycardDirectCaptureCommand</item>
                <item name="refund" xsi:type="string">MpBarclaycardDirectRefundCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Command managers section -->
    <virtualType name="MpBarclaycardDirectCommandManager" type="Magento\Payment\Gateway\Command\CommandManager">
        <arguments>
            <argument name="commandPool" xsi:type="object">MpBarclaycardDirectCommandPool</argument>
        </arguments>
    </virtualType>

    <!-- Authorize command -->
    <virtualType name="MpBarclaycardDirectAuthorizeCommand" type="Mageplaza\Barclaycard\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Mageplaza\Barclaycard\Gateway\Request\AuthorizationRequest</argument>
            <argument name="transferFactory" xsi:type="object">Mageplaza\Barclaycard\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Mageplaza\Barclaycard\Gateway\Http\Client\ClientMock</argument>
            <argument name="validator" xsi:type="object">Mageplaza\Barclaycard\Gateway\Validator\ResponseCodeValidator</argument>
            <argument name="handler" xsi:type="object">Mageplaza\Barclaycard\Gateway\Response\AuthorizeResponseHandler</argument>
            <argument name="paymentLogger" xsi:type="object">MpBarclaycardDirectLog</argument>
        </arguments>
    </virtualType>

    <!-- Capture command -->
    <virtualType name="MpBarclaycardDirectCaptureCommand" type="Mageplaza\Barclaycard\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Mageplaza\Barclaycard\Gateway\Request\CaptureRequest</argument>
            <argument name="transferFactory" xsi:type="object">Mageplaza\Barclaycard\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Mageplaza\Barclaycard\Gateway\Http\Client\ClientMock</argument>
            <argument name="validator" xsi:type="object">Mageplaza\Barclaycard\Gateway\Validator\ResponseCodeValidator</argument>
            <argument name="handler" xsi:type="object">Mageplaza\Barclaycard\Gateway\Response\CaptureResponseHandler</argument>
            <argument name="paymentLogger" xsi:type="object">MpBarclaycardDirectLog</argument>
        </arguments>
    </virtualType>

    <!-- Refund command -->
    <virtualType name="MpBarclaycardDirectRefundCommand" type="Mageplaza\Barclaycard\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Mageplaza\Barclaycard\Gateway\Request\RefundRequest</argument>
            <argument name="transferFactory" xsi:type="object">Mageplaza\Barclaycard\Gateway\Http\TransferFactory</argument>
            <argument name="client" xsi:type="object">Mageplaza\Barclaycard\Gateway\Http\Client\ClientMock</argument>
            <argument name="validator" xsi:type="object">Mageplaza\Barclaycard\Gateway\Validator\ResponseCodeValidator</argument>
            <argument name="handler" xsi:type="object">Mageplaza\Barclaycard\Gateway\Response\RefundResponseHandler</argument>
            <argument name="paymentLogger" xsi:type="object">MpBarclaycardDirectLog</argument>
        </arguments>
    </virtualType>

    <!-- Value handlers infrastructure -->
    <virtualType name="MpBarclaycardDirectValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">MpBarclaycardDirectConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="MpBarclaycardDirectConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Direct</argument>
        </arguments>
    </virtualType>
    <!-- END Value handlers infrastructure -->

    <virtualType name="MpBarclaycardDirectInfoBlock" type="Mageplaza\Barclaycard\Block\Info">
        <arguments>
            <argument name="config" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Direct</argument>
        </arguments>
    </virtualType>

    <!-- ========================================== HOSTED INTEGRATION ========================================== -->

    <!-- Payment Method Facade configuration -->
    <virtualType name="MpBarclaycardHostedFacade" type="Mageplaza\Barclaycard\Model\Payment\Hosted">
        <arguments>
            <argument name="code" xsi:type="const">Mageplaza\Barclaycard\Model\Payment\Hosted::CODE</argument>
            <argument name="formBlockType" xsi:type="string">Magento\Payment\Block\Form</argument>
            <argument name="infoBlockType" xsi:type="string">MpBarclaycardHostedInfoBlock</argument>
            <argument name="valueHandlerPool" xsi:type="object">MpBarclaycardHostedValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">MpBarclaycardHostedValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">MpBarclaycardHostedCommandPool</argument>
        </arguments>
    </virtualType>

    <!-- Configuration reader -->
    <type name="Mageplaza\Barclaycard\Gateway\Config\Hosted">
        <arguments>
            <argument name="methodCode" xsi:type="const">Mageplaza\Barclaycard\Model\Payment\Hosted::CODE</argument>
        </arguments>
    </type>
    <virtualType name="MpBarclaycardHostedCountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Hosted</argument>
        </arguments>
    </virtualType>
    <virtualType name="MpBarclaycardHostedValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">MpBarclaycardHostedCountryValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Logger, initialized with Hosted Config -->
    <virtualType name="MpBarclaycardHostedLog" type="Magento\Payment\Model\Method\Logger">
        <arguments>
            <argument name="config" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Hosted</argument>
        </arguments>
    </virtualType>

    <!-- Commands infrastructure -->
    <virtualType name="MpBarclaycardHostedCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">MpBarclaycardHostedAuthorizeCommand</item>
                <item name="capture" xsi:type="string">MpBarclaycardHostedCaptureCommand</item>
                <item name="refund" xsi:type="string">MpBarclaycardHostedRefundCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Command managers section -->
    <virtualType name="MpBarclaycardHostedCommandManager" type="Magento\Payment\Gateway\Command\CommandManager">
        <arguments>
            <argument name="commandPool" xsi:type="object">MpBarclaycardHostedCommandPool</argument>
        </arguments>
    </virtualType>

    <!-- Authorize command -->
    <virtualType name="MpBarclaycardHostedAuthorizeCommand" type="MpBarclaycardDirectAuthorizeCommand">
        <arguments>
            <argument name="paymentLogger" xsi:type="object">MpBarclaycardHostedLog</argument>
        </arguments>
    </virtualType>

    <!-- Capture command -->
    <virtualType name="MpBarclaycardHostedCaptureCommand" type="MpBarclaycardDirectCaptureCommand">
        <arguments>
            <argument name="paymentLogger" xsi:type="object">MpBarclaycardHostedLog</argument>
        </arguments>
    </virtualType>

    <!-- Refund command -->
    <virtualType name="MpBarclaycardHostedRefundCommand" type="MpBarclaycardDirectRefundCommand">
        <arguments>
            <argument name="paymentLogger" xsi:type="object">MpBarclaycardHostedLog</argument>
        </arguments>
    </virtualType>

    <!-- Value handlers infrastructure -->
    <virtualType name="MpBarclaycardHostedValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">MpBarclaycardHostedConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="MpBarclaycardHostedConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Hosted</argument>
        </arguments>
    </virtualType>
    <!-- END Value handlers infrastructure -->

    <virtualType name="MpBarclaycardHostedInfoBlock" type="Mageplaza\Barclaycard\Block\Info">
        <arguments>
            <argument name="config" xsi:type="object">Mageplaza\Barclaycard\Gateway\Config\Hosted</argument>
        </arguments>
    </virtualType>
</config>
